# 자바 ORM 표준 JPA 프로그래밍  
; https://book.naver.com/bookdb/book_detail.nhn?bid=9252528  

---  

## H2 데이터베이스 설치  

> 다운로드  

http://www.h2database.com 에서 All Platforms or Platform-Independent Zip  

> bin/h2.sh (bin/h2.bat) 실행  

---  

## 정리  

### 3. 영속성 관리

- 엔티티 매니저는 엔티티 매니저 팩토리에서 생성 됨  
(J2SE 환경에서는 엔티티 매니저를 만들면 그 내부에 영속성 컨텍스트도 함께 만들어 짐)  
- 영속성 컨텍스트는 애플리케이션과 데이터베이스 사이에서 객체를 보관하는 가상의 데이터베이스 역할을 함  
=> 1차 캐시, 동일성 보장, 트랜잭션을 지원하는 쓰기 지연, 변경 감지, 지연 로딩 기능을 사용할 수 있음
- 영속성 컨텍스트에 저장한 엔티티는 플러시 시점에 데이터베이스에 반영  
(일반적으로 트랜잭션을 커밋할 때 영속성 컨텍스트가 플러시 됨)  
- 영속성 컨텍스트가 관리하는 엔티티를 **영속 상태** 의 엔티티라고 함. 더 이상 관리하지 못하면  
**준영속 상태의 엔티티** 라 함. 준영속 상태의 엔티티는 영속성 컨텍스트가 제공하는 위의 기능들을  
사용할 수 없음  

### 4. 엔티티 매핑  

- @Entity @Table을 통한 객체와 테이블 매핑
- 키 매핑 전략
  - 직접 할당
  - IDENTITY : 기본 키 생성을 데이터베이스에 위임
  - SEQUENCE : 데이터베이스 시퀀스를 사용해 기본 키를 할당
  - TABLE : 키 생성 테이블을 사용
  - AUTO : 선택한 데이터베이스 방언에 따라 IDENTITY, SEQUENCE, TABLE 전략 중 하나 사용
- 필드와 컬럼 매핑
  - @Column : 컬럼을 매핑
  - @Enumerated : 자바의 enum 타입을 매핑
  - @Temporal : 날짜 타입을 매핑
  - @Lob : BLOB, CLOB 타입을 매핑
  - @Transient : 특정 필드를 데이터베이스에 매핑X
  - @Access : JPA가 엔티티에 접근하는 방식을 지정  

### 5. 연관관계 매핑 기초  

- 방향(Direction) : [단방향, 양방향] 방향은 객체에만 존재, 테이블은 항상 양방향  
- 다중성(Multiplicity) : [다대일(N:1), 일대다(1:N), 일대일(1:1), 다대다(N:M)]
- 연관관계의 주인(Owner) : 객체를 양방향 연관관계로 만들면 주인을 정해야 함  
=>  
- 단방향 매핑만으로 테이블과 객체의 연관관계 매핑은 이미 완료
- 단방향을 양방향으로 만들면 반대방향으로 객체 그래프 탐색 기능이 추가
- 양방향 연관관계를 매핑하려면 객체에서 양쪽 방향을 모두 관리해야 함

### 6. 연관관계 매핑 기초  

- 다대일(N:1)
- 일대다(1:N)
- 일대일(1:1)
- 다대다(N:M)  
  - 식별 관계 : 받아온 식별자를 기본 키 + 외래키로 사용
  - 비식별 관계 : 받아온 식별자를 외래 키로만 사용하고 새로운 식별자를 추가  

### 7. 고급 매핑  

- 상속 관계 매핑
  - 각각의 테이블로 변환 : JPA 조인 전략
    - 장점
      - 테이블이 정규화 됨
      - 외래 키 참조 무결성 제약조건을 활용
      - 저장공간을 효율적으로 사용
    - 단점
      - 조회할 때 조인이 많이 사용되므로 성능이 저하 될 수 있음
      - 조회 쿼리가 복잡
      - 테이블을 등록할 INSERT SQL을 두 번 실행
    - 특징
      - JPA 표준 명세는 구분 컬럼을 사용하도록 하지만, 하이버네이트 등은 @DiscriminatorColumn 없이도 동작
    - 관련 어노테이션
      - @PrimaryKeyJoinColumn, @DiscriminatorColumn, @DiscriminatorValue
  - 통합 테이블로 변환 : JPA 단일 테이블 전략
    - 장점
      - 조인이 필요없으므로 일반적으로 조회 성능이 빠르다
      - 조회 쿼리가 단순하다
    - 단점
      - 자식 엔티티가 매핑한 컬럼은 모두 null을 허용해야 함
      - 단일 테이블에 모두 저장하므로 테이블이 커질 수 있음.(상황에 따라 조회가 더 느릴 수도)
    - 특징
      - 구분 컬럼을 꼭 사용해야 한다
      - @DiscriminatorValue를 지정하지 않으면 기본으로 엔티티 이름을 사용한다.
  - 서브타입 테이블로 변환 : JPA 구현 클래스마다 테이블 전략
    - 장점
      - 서브 타입을 구분해서 처리할 때 효과적
      - not null 제약조건을 사용할 수 있음      
    - 단점
      - 여러 자식 테이블을 함께 조회할 때 성능이 느림(SQL에 UNION 사용해야 함)
      - 자식 테이블을 통합해서 쿼리하기 힘듬
    - 특징
      - 구분 컬럼을 사용하지 않음
- @MappedSuperclass
  - 자식 클래스에게 매핑 정보만 제공
- 복합 키와 식별 관계 매핑
  - 식별 관계(Identifying Relationship) : 부모 테이블의 키를 내려 받아서 자식 테이블의 기본 키 + 외래키로 사용
  - 비식별 관계(Non-Identifying Relationship) : 부모 테이블의ㅏ 키를 받아서 자식 테이블의 외래키로만 사용
- 조인 테이블  
- 엔티티 하나에 여러 테이블 매핑
